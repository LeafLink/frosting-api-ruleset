extends:
  - spectral:oas
  - ./jsonapi-content-negotiation-clients.yaml
  - ./jsonapi-content-negotiation-servers.yaml
  - ./jsonapi-document-structure-top-level.yaml
  - ./jsonapi-document-structure-jsonapi-object.yaml
  - ./jsonapi-errors-error-object.yaml
  - ./jsonapi-crud-resource-allowed-methods-ruleset.yaml
  - ./jsonapi-document-structure-member-names.yaml
  - ./jsonapi-document-structure-return-codes.yaml
  - ./frosting-profile-document-path.yaml
  - ./frosting-profile-document-structure-filtering.yaml
  - ./frosting-profile-document-structure-member-names.yaml
  - ./frosting-profile-document-structure-pagination.yaml
rules:
  attributes-object-type:
    description: The value of the attributes key MUST be an object (an “attributes object”)
    documentationUrl: https://jsonapi.org/format/#document-resource-object-attributes
    message: "{{path}} - {{description}}"
    severity: error
    given: $..properties[?(@property === 'attributes')]
    then:
      field: type
      function: enumeration
      functionOptions:
        values:
          - object
  attributes-object-properties:
    description: Any object that constitutes or is contained in an attribute MUST NOT contain a relationships or links member.
    documentationUrl: https://jsonapi.org/format/#document-resource-object-attributes
    message: "{{path}} - {{description}}"
    severity: error
    given: $..properties[?(@property === 'attributes')].properties
    then:
      - field: relationships
        function: falsy
      - field: links
        function: falsy
  resource-identification-property:
    description: Every resource object MUST contain an id member and a type member. The values of the id and type members MUST be strings.
    documentationUrl: https://jsonapi.org/format/#document-resource-object-identification
    message: "{{path}} - {{description}}"
    severity: error
    given: $..properties[?(@property === 'data' || @property === 'included')]..allOf.*.properties
    then:
      field: "@key"
      function: enumeration
      functionOptions:
        values:
          - type
          - id
  resource-identification-type:
    description: Every resource object MUST contain an id member and a type member. The values of the id and type members MUST be strings.
    documentationUrl: https://jsonapi.org/format/#document-resource-object-identification
    message: "{{path}} - {{description}}"
    severity: error
    given: $..properties[?(@property === 'data' || @property === 'included')]..allOf.*.properties[?(@property === 'id' || @property === 'type')]
    then:
      field: type
      function: enumeration
      functionOptions:
        values:
          - string
  resource-object-properties-object:
    description: Must follow resource object properties
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[?(@property === 'data' || @property === 'included')][?(@property === 'type' && @ === 'object')]^.properties
    then:
      field: "@key"
      function: enumeration
      functionOptions:
        values:
          - type
          - id
          - attributes
          - relationships
          - links
          - meta
  resource-object-properties-array:
    description: Must follow resource object properties
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[?(@property === 'data' || @property === 'included')][?(@property === 'type' && @ === 'array')]^..allOf.*.properties
    then:
      field: "@key"
      function: enumeration
      functionOptions:
        values:
          - type
          - id
          - attributes
          - relationships
          - links
          - meta
  resource-object-properties-type-object:
    description: Top level members of resource object must be of type object
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[?(@property === 'data' || @property === 'included')][?(@property === 'type' && @ === 'object')]^.properties[?(@property === 'attributes' || @property === 'relationships' || @property === 'links' || @property === 'meta')]
    then:
      field: type
      function: enumeration
      functionOptions:
        values:
          - object
  resource-object-properties-type-array:
    description: Top level members of resource object must be of type object
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[?(@property === 'data' || @property === 'included')][?(@property === 'type' && @ === 'array')]^..allOf.*.properties[?(@property === 'attributes' || @property === 'relationships' || @property === 'links' || @property === 'meta')]
    then:
      field: type
      function: enumeration
      functionOptions:
        values:
          - object
  resource-object-properties-included-object:
    description: A resource object must contain the top-level members type and id
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths.*.[?(@property === 'requestBody' && @parentProperty !== 'post' || @property === 'responses')]..content[?(@property === 'application/vnd.api+json')].schema.properties[?(@property === 'data' || @property === 'included')][?(@property === 'type' && @ === 'object')]^.properties
    then:
      - field: type
        function: truthy
      - field: id
        function: truthy
  resource-object-properties-included-array:
    description: A resource object must contain the top-level members type and id
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths.*.[?(@property === 'requestBody' && @parentProperty !== 'post' || @property === 'responses')]..content[?(@property === 'application/vnd.api+json')].schema.properties[?(@property === 'data' || @property === 'included')][?(@property === 'type' && @ === 'array')]^..allOf.*.properties
    then:
      - field: type
        function: truthy
      - field: id
        function: truthy
  resource-object-id-exception:
    description: The id member is not required when the resource object originates at the client and represents a new resource to be created on the server
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths..[?(@property === 'post')][?(@property === 'requestBody')]..schema.properties[?(@property === 'data' || @property === 'included')].properties
    then:
      field: type
      function: truthy
  links-object:
    description: The value of each links member MUST be an object (a “links object”)
    documentationUrl: https://jsonapi.org/format/#document-meta
    message: "{{path}} - {{description}}"
    severity: error
    given: $..properties[?(@property === 'links')]
    then:
      field: type
      function: enumeration
      functionOptions:
        values:
          - object
  links-object-schema-type:
    description: A link must be represented as either a string containing the link's URL or an object
    documentationUrl: https://jsonapi.org/format/#document-links
    message: "{{path}} - {{description}}"
    severity: error
    given: $..properties[?(@property === 'links')].properties.'*'
    then:
      field: type
      function: enumeration
      functionOptions:
        values:
          - object
          - string
  links-object-schema-properties:
    description: An object (“link object”) which can contain the following members (href and meta)
    documentationUrl: https://jsonapi.org/format/#document-links
    message: "{{path}} - {{description}}"
    severity: error
    given: $..properties[?(@property === 'links')].properties.'*'.properties
    then:
      field: "@key"
      function: enumeration
      functionOptions:
        values:
          - href
          - meta
  links-object-schema-properties-href:
    description: Href is a string containing the link's URL
    documentationUrl: https://jsonapi.org/format/#document-links
    message: "{{path}} - {{description}}"
    severity: error
    given: $..properties[?(@property === 'links')].properties.'*'.properties[?(@property === 'href')]
    then:
      field: type
      function: enumeration
      functionOptions:
        values:
          - string
  meta-object-schema:
    description: The value of each meta member MUST be an object (a “meta object”)
    documentationUrl: https://jsonapi.org/format/#document-meta
    message: "{{path}} - {{description}}"
    severity: error
    given: $..properties[?(@property === 'meta')]
    then:
      field: type
      function: enumeration
      functionOptions:
        values:
          - object
